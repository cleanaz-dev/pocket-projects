// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserType {
  PARENT
  CHILD
}

enum LinkType {
  VIDEO
  DOCS
  IMAGE
  WEB
  PDF
}

model Family {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  users     User[]
  projects  Project[]
  createdAt DateTime  @default(now())
}

model User {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  email     String?
  name      String
  password  String?
  avatar    String?
  color     String?
  username  String?   @unique
  type      UserType
  familyId  String    @db.ObjectId
  family    Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  projects  Project[]
  createdAt DateTime  @default(now())
  rewards   Rewards?  @relation(fields: [rewardsId], references: [id])
  rewardsId String?   @db.ObjectId
  chats     ChatSession[] // Add this relation
}

model Project {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  coverImage  String?
  color       String?
  status      ProjectStatus @default(DRAFT)
  dueDate     DateTime?
  category    String? // "Science", "History", etc.
  grade       String? // "Grade 4", "Grade 5", etc.
  ownerId     String        @db.ObjectId
  owner       User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  familyId    String        @db.ObjectId
  family      Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  researches  Research[]
  notes       Note[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  chats     ChatSession[]
}

model ChatSession {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  title     String?       @default("New Chat")
  persona   String        // "guru", "friend", "parent"
  
  userId    String        @db.ObjectId
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  projectId String?       @db.ObjectId
  project   Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  messages  ChatMessage[]
  
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model ChatMessage {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  role      ChatRole
  content   String
  
  chatId    String      @db.ObjectId
  chat      ChatSession @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  createdAt DateTime    @default(now())
}

enum ProjectStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
}

model Research {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  projectId String    @db.ObjectId
  criteria  String
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  webLinks  WebLink[]
  ytLinks   YtLink[]
  imgLinks  ImgLink[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model WebLink {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  url        String
  summary    String?
  type       LinkType @default(WEB)
  researchId String   @db.ObjectId
  research   Research @relation(fields: [researchId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  aiSummary  String?
}

model YtLink {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  url        String
  summary    String?
  type       LinkType @default(VIDEO)
  researchId String   @db.ObjectId
  research   Research @relation(fields: [researchId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  aiSummary  String?
}

model ImgLink {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  url        String
  summary    String?
  type       LinkType @default(IMAGE)
  researchId String   @db.ObjectId
  research   Research @relation(fields: [researchId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  aiSummary String?
}

model Note {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  projectId String   @db.ObjectId
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Rewards {
  id   String @id @default(auto()) @map("_id") @db.ObjectId
  name String
  user User[]
}

enum ChatRole {
  user
  assistant
  system
}